{% extends 'master.html' %}

{% block content %}
<div class="main page-content">
{% block general_content %}{% endblock %}
</div>
<!-- ##### Pendo.io bits #### -->

{% if not debug %}
<script>
    // Please use Strings, Numbers, or Bools for value types.
    window.pendo_options = {
        apiKey: 'dbde1b37-ee77-4baf-695a-d7a7752b9c78',

         // If you load your user info asynchronously, set this to true
         usePendoAgentAPI: false,

        visitor: {
          id:              parseInt("{{ user.id }}"),   // Required if user is logged in
          email:           "{{ user.email }}",
          github_user:     "{{ user.github_user }}"

          // You can add any additional visitor level key-values here,
          // as long as it's not one of the above reserved names.
        },

        account: {
          // id:           // Highly recommended
          // name:         // Optional
          // planLevel:    // Optional
          // planPrice:    // Optional
          // creationDate: // Optional

          // You can add any additional account level key-values here,
          // as long as it's not one of the above reserved names.
        }
    };
    (function() {
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.async = true;
        script.src = ('https:' === document.location.protocol ? 'https://' : 'http://' ) + 'd3accju1t3mngt.cloudfront.net/js/pa.min.js';
        var firstScript = document.getElementsByTagName('script')[0];
        firstScript.parentNode.insertBefore(script, firstScript);
    })();
</script>
{% endif %}

<script>
    /*
     * Provide current user info
     */
    'use strict';
    (function(angular) {

        var mod = angular.module('currentUserService', ['ngResource']);

        mod.factory('currentUserService', ['$resource', _factory]);

        function _factory($resource) {
            var userData = {
                "id": ("{{ user.id }}" == "None") ? null : parseInt("{{ user.id }}"), 
                "authenticated": ("{{ user.is_authenticated }}" == "True") ? true : false, 
                "staff": ("{{ user.is_staff }}" == "True") ? true : false, 
                "username": "{{ user.username }}", 
                "created": ("{{ user.date_joined }}" == "") ? null : "{{ user.date_joined }}", 
                "modified": ("{{ user.last_login }}" == "") ? null : "{{ user.last_login }}", 
                "active": ("{{ user.is_active }}" == "True") ? true : false,
                "connected_to_github": ("{{ connected_to_github }}" == "True") ? true : false,
                "cache_refreshed": ("{{ user.cache_refreshed }}" == "True") ? true : false,
                "subscriptions": [
                    {% for subscription in user.get_subscriptions %}
                        {
                           id: {{ subscription.id }},
                           github_user: "{{ subscription.github_user }}",
                           github_repo: "{{ subscription.github_repo }}"
                        }
                        {% if not forloop.last %},{%  endif %}
                    {% endfor %}
                ],
                "starred": [
                    {% for star in user.get_starred %}
                        {
                           id: {{ star.id }},
                           github_user: "{{ star.github_user }}",
                           github_repo: "{{ star.github_repo }}"
                        }
                        {% if not forloop.last %},{%  endif %}
                    {% endfor %}
                ],
                "update": function() {
                    // refresh anything about the user that may change
                    return $resource('/api/v1/users/' + userData.id + '/').get().$promise.then(function(response) {
                        userData.cache_refreshed = response.cache_refreshed;
                        userData.subscriptions = response.summary_fields.subscriptions;
                        userData.starred = response.summary_fields.starred;
                        return userData;
                    });
                }
            };

            return userData;
        }
    })(angular);
</script>
{% endblock %}

